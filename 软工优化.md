ä¼˜åŒ–äº‹é¡¹ï¼š

# ç§èŠå®ç°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Spring Boot + WebSocket + MySQL** çš„å®Œæ•´å®ç°æ–¹æ¡ˆã€‚æˆ‘ä»¬å°†é‡‡ç”¨**â€œåŒå†™Inboxæ¨¡å¼â€**æ¥å¤„ç†ä¼šè¯åˆ—è¡¨ï¼Œå¹¶ç»“åˆ**â€œå‰ç«¯è·¯ç”±ä¼˜å…ˆ + åç«¯æ•°æ®æŒä¹…åŒ–â€**çš„ç­–ç•¥æ¥å¤„ç†å•†å“ä¸Šä¸‹æ–‡ã€‚

------

### ä¸€ã€ æ•°æ®åº“è®¾è®¡ (Schema Design)

æ ¸å¿ƒåœ¨äºæ‹†åˆ†â€œä¼šè¯åˆ—è¡¨â€ä¸â€œæ¶ˆæ¯è®°å½•â€ï¼Œå¹¶åˆ©ç”¨ JSON å­—æ®µç¡®ä¿å­˜å‚¨çµæ´»æ€§ã€‚

#### 1. æ ¸å¿ƒè¡¨ç»“æ„

SQL

```
-- 1. ä¼šè¯åˆ—è¡¨è¡¨ (chat_conversations)
-- é‡‡ç”¨"å†™æ‰©æ•£"æ¨¡å¼ï¼šAå’ŒBèŠå¤©ï¼Œè¡¨é‡Œæœ‰ä¸¤è¡Œè®°å½•(Aå­˜ä¸€è¡Œï¼ŒBå­˜ä¸€è¡Œ)
CREATE TABLE `chat_conversations` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `owner_id` BIGINT NOT NULL COMMENT 'åˆ—è¡¨æ‰€æœ‰è€…ID',
    `peer_id` BIGINT NOT NULL COMMENT 'èŠå¤©å¯¹è±¡ID',
    
    -- [å…³é”®] ä¸Šä¸‹æ–‡ç»‘å®šå­—æ®µï¼šå†³å®šåˆ—è¡¨é¡µæ˜¾ç¤º"åœ¨èŠ: iPhone 13"
    `related_product_id` BIGINT COMMENT 'å½“å‰å…³è”å•†å“ID',
    `related_product_info` JSON COMMENT 'å•†å“å¿«ç…§(å­˜æ ‡é¢˜/å›¾ç‰‡ï¼Œé¿å…æŸ¥è¡¨)',
    
    `last_msg_content` VARCHAR(255) COMMENT 'æœ€åä¸€æ¡æ¶ˆæ¯é¢„è§ˆ',
    `last_msg_time` DATETIME COMMENT 'æ’åºç”¨',
    `unread_count` INT DEFAULT 0 COMMENT 'æœªè¯»æ•°',
    
    UNIQUE KEY `uk_owner_peer` (`owner_id`, `peer_id`), -- å”¯ä¸€çº¦æŸï¼šä¸¤äººåªæœ‰ä¸€ä¸ªä¼šè¯
    INDEX `idx_owner_time` (`owner_id`, `last_msg_time`) -- åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–
);

-- 2. æ¶ˆæ¯è®°å½•è¡¨ (chat_messages)
CREATE TABLE `chat_messages` (
    `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
    `sender_id` BIGINT NOT NULL,
    `receiver_id` BIGINT NOT NULL,
    
    -- 0:æ–‡æœ¬, 1:å›¾ç‰‡, 2:å•†å“å¡ç‰‡, 3:ç³»ç»Ÿ/è®¢å•é€šçŸ¥
    `msg_type` TINYINT DEFAULT 0, 
    `content` TEXT,
    
    -- [å…³é”®] æ‰©å±•å­—æ®µï¼šå­˜å•†å“å¡ç‰‡è¯¦æƒ…ã€è®¢å•çŠ¶æ€ç­‰
    -- æ ¼å¼: {"productId":101, "price":500, "title":"..."}
    `extra_data` JSON, 
    
    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

------

### äºŒã€ ä¸šåŠ¡ç”¨ä¾‹ (Use Case)

**åœºæ™¯ï¼š** ç”¨æˆ· **August (ä¹°å®¶)** æƒ³è¦è´­ä¹° **Seller (å–å®¶)** çš„ä¸€å° **"iPhone 13" (ID: 5001)**ã€‚

#### æµç¨‹æ¦‚è§ˆï¼š

1. **è¿›åœº**ï¼šAugust ä»è¯¦æƒ…é¡µç‚¹å‡»â€œç§èŠâ€ã€‚
2. **å±•ç¤º**ï¼šèŠå¤©é¡µé¡¶éƒ¨å‡ºç°â€œiPhone 13â€æ‚¬æµ®æ¡ã€‚
3. **å‘é€**ï¼šAugust å‘é€â€œè¿˜åœ¨å—ï¼Ÿâ€ï¼Œç³»ç»Ÿè‡ªåŠ¨ç»‘å®šä¸Šä¸‹æ–‡ã€‚
4. **åˆ—è¡¨**ï¼šSeller æ”¶åˆ°æ¶ˆæ¯ï¼Œåˆ—è¡¨é¡µæ˜¾ç¤º August åœ¨é—®â€œiPhone 13â€ã€‚
5. **åˆ‡æ¢**ï¼šAugust åæ¥åˆå»çœ‹äº†å–å®¶çš„â€œMacBookâ€ï¼Œç‚¹å‡»ç§èŠï¼Œæ‚¬æµ®æ¡è‡ªåŠ¨åˆ‡æ¢ã€‚

------

### ä¸‰ã€ å…¨æµç¨‹æ·±åº¦åˆ†æ

#### é˜¶æ®µ 1ï¼šè¿›å…¥èŠå¤© (Context Injection)

- **å‰ç«¯**ï¼šAugust ç‚¹å‡»æŒ‰é’®ï¼Œè·¯ç”±è·³è½¬ `/chat?targetId=Seller&productId=5001`ã€‚
- **æ¸²æŸ“é€»è¾‘**ï¼š
  - å‰ç«¯æ£€æµ‹åˆ° URL å¸¦ `productId=5001`ã€‚
  - **å¿½ç•¥**æ•°æ®åº“é‡Œå¯èƒ½çš„æ—§å…³è”ï¼Œå¼ºåˆ¶è°ƒç”¨ API è·å– ID ä¸º 5001 çš„å•†å“ä¿¡æ¯ã€‚
  - æ¸²æŸ“é¡¶éƒ¨ **[å•†å“æ‚¬æµ®æ¡]**ã€‚
- **æ³¨æ„**ï¼šæ­¤æ—¶**ä¸è°ƒç”¨**åç«¯ä¿®æ”¹æ•°æ®åº“ï¼Œä»…å‰ç«¯å±•ç¤ºã€‚

#### é˜¶æ®µ 2ï¼šå‘é€æ¶ˆæ¯ (Context Persistence)

- **å‰ç«¯**ï¼šAugust è¾“å…¥â€œè¿˜èƒ½ä¾¿å®œå—â€ï¼Œç‚¹å‡»å‘é€ã€‚

- **Socket payload**ï¼š

  JSON

  ```
  {
    "to": "Seller",
    "type": 0, // æ–‡æœ¬
    "content": "è¿˜èƒ½ä¾¿å®œå—",
    "currentProductId": 5001 // [å…³é”®] å¸¦ä¸Šå½“å‰çš„ä¸Šä¸‹æ–‡
  }
  ```

- **åç«¯å¤„ç†**ï¼š

  1. å­˜å…¥ `chat_messages`ã€‚
  2. æ›´æ–° **August** çš„ä¼šè¯è¡¨ï¼šæ›´æ–° `last_msg`ï¼ŒåŒæ—¶æ›´æ–° `related_product_id = 5001`ã€‚
  3. æ›´æ–° **Seller** çš„ä¼šè¯è¡¨ï¼šæ›´æ–° `last_msg`ï¼Œ`unread_count + 1`ï¼ŒåŒæ—¶æ›´æ–° `related_product_id = 5001`ã€‚

#### é˜¶æ®µ 3ï¼šæŸ¥çœ‹åˆ—è¡¨ (List View)

- **Seller ç«¯**ï¼šæ‰“å¼€æ¶ˆæ¯åˆ—è¡¨ã€‚
- **å‰ç«¯**ï¼šæ¸²æŸ“åˆ—è¡¨é¡¹ã€‚è¯»å– `related_product_id`ï¼Œåœ¨å¤´åƒæ—æ˜¾ç¤ºæ ‡ç­¾ **[åœ¨èŠ: iPhone 13]**ã€‚

------

### å››ã€ ä»£ç å¤§è‡´å®ç°æ€è·¯

è¿™æ˜¯ä¸€ä¸ªéå¸¸è½åœ°çš„å·¥ç¨‹åŒ–éœ€æ±‚ã€‚æˆ‘ä»¬å°†åŸºäº **Spring Boot + MyBatis-Plus** (åç«¯ä¸»æµ) å’Œ **Vue 3 + Composition API** (å‰ç«¯ä¸»æµ) æ¥ç»†åŒ–æ¯ä¸€å±‚çš„ä»£ç ã€‚

æˆ‘ä»¬å°†é‡ç‚¹å±•ç¤º **â€œå¦‚ä½•é€šè¿‡ä¸€æ¬¡å‘é€æ¶ˆæ¯ï¼ŒåŒæ—¶æ›´æ–°æ¶ˆæ¯è®°å½•å’Œä¼šè¯çŠ¶æ€â€** çš„æ ¸å¿ƒé€»è¾‘ã€‚

### ç¬¬ä¸€éƒ¨åˆ†ï¼šåç«¯å¼€å‘ (Server)

æŠ€æœ¯æ ˆå‡è®¾ï¼šSpring Boot, MyBatis-Plus, Lombok, MySQLã€‚

#### 1. Model (å®ä½“å±‚)

æˆ‘ä»¬éœ€è¦æ˜ å°„æ•°æ®åº“çš„ä¸¤å¼ è¡¨ï¼Œæ³¨æ„ JSON å­—æ®µçš„å¤„ç†ã€‚

Java

```
// Entity: ä¼šè¯åˆ—è¡¨
@Data
@TableName(value = "chat_conversations", autoResultMap = true)
public class ChatConversation {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long ownerId; // åˆ—è¡¨å½’å±è€…
    private Long peerId;  // èŠå¤©å¯¹è±¡
    
    // æ ¸å¿ƒï¼šå½“å‰ä¸Šä¸‹æ–‡å•†å“ID
    private Long relatedProductId;
    
    // æ ¸å¿ƒï¼šå•†å“å¿«ç…§ (ä½¿ç”¨MyBatis-Plusçš„JacksonTypeHandlerè‡ªåŠ¨è½¬JSON)
    @TableField(typeHandler = JacksonTypeHandler.class)
    private ProductSnapshot relatedProductInfo; 
    
    private String lastMsgContent;
    private Date lastMsgTime;
    private Integer unreadCount;
}

// Entity: æ¶ˆæ¯è®°å½•
@Data
@TableName(value = "chat_messages", autoResultMap = true)
public class ChatMessage {
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private Long senderId;
    private Long receiverId;
    private Integer msgType; // 0:æ–‡æœ¬, 1:å›¾ç‰‡, 2:å•†å“å¡ç‰‡
    private String content;
    
    @TableField(typeHandler = JacksonTypeHandler.class)
    private Map<String, Object> extraData; // å­˜å•†å“è¯¦æƒ…ç­‰
    
    private Date createTime;
}

// DTO: å•†å“å¿«ç…§ç®€å•å¯¹è±¡
@Data
public class ProductSnapshot {
    private Long id;
    private String title;
    private String price;
    private String imgUrl;
}
```

#### 2. Dao / Mapper (æ•°æ®è®¿é—®å±‚)

è¿™é‡Œæœ€å…³é”®çš„æ˜¯å®ç° **Upsert (å­˜åœ¨å³æ›´æ–°ï¼Œä¸å­˜åœ¨å³æ’å…¥)** é€»è¾‘ï¼Œä¿è¯ä¼šè¯åˆ—è¡¨çš„é«˜æ•ˆæ›´æ–°ã€‚

Java

```
@Mapper
public interface ChatConversationMapper extends BaseMapper<ChatConversation> {

    // è‡ªå®šä¹‰ SQL å®ç°é«˜æ€§èƒ½ Upsert
    // å¦‚æœ owner+peer å­˜åœ¨ï¼Œåˆ™æ›´æ–°æœ€åæ¶ˆæ¯å’Œå…³è”å•†å“ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ’å…¥
    @Update("INSERT INTO chat_conversations " +
            "(owner_id, peer_id, related_product_id, related_product_info, last_msg_content, last_msg_time, unread_count) " +
            "VALUES (#{ownerId}, #{peerId}, #{relatedProductId}, #{relatedProductInfo, typeHandler=...}, #{lastMsgContent}, #{lastMsgTime}, #{unreadCount}) " +
            "ON DUPLICATE KEY UPDATE " +
            "last_msg_content = VALUES(last_msg_content), " +
            "last_msg_time = VALUES(last_msg_time), " +
            "related_product_id = VALUES(related_product_id), " + // é‡ç‚¹ï¼šæ›´æ–°ä¸Šä¸‹æ–‡
            "related_product_info = VALUES(related_product_info), " +
            "unread_count = unread_count + VALUES(unread_count)") 
    void saveOrUpdateConversation(ChatConversation conversation);
}
```

#### 3. Service (ä¸šåŠ¡é€»è¾‘å±‚)

è¿™æ˜¯æ•´ä¸ªé€»è¾‘çš„å¿ƒè„ã€‚

Java

```
@Service
public class ChatService {

    @Autowired private ChatMessageMapper messageMapper;
    @Autowired private ChatConversationMapper conversationMapper;
    @Autowired private ProductService productService; // ç”¨äºè·å–å•†å“è¯¦æƒ…

    /**
     * å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•
     * @param senderId å‘é€è€…
     * @param receiverId æ¥æ”¶è€…
     * @param content æ¶ˆæ¯å†…å®¹
     * @param currentContextProductId å‰ç«¯ä¼ æ¥çš„å½“å‰æ‚¬æµ®æ¡ID (å¯èƒ½ä¸ºç©º)
     */
    @Transactional(rollbackFor = Exception.class)
    public void sendMessage(Long senderId, Long receiverId, String content, Long currentContextProductId) {
        Date now = new Date();

        // 1. ä¿å­˜å…·ä½“æ¶ˆæ¯ (Messageè¡¨)
        ChatMessage msg = new ChatMessage();
        msg.setSenderId(senderId);
        msg.setReceiverId(receiverId);
        msg.setContent(content);
        msg.setCreateTime(now);
        // å¦‚æœæ˜¯å‘é€å•†å“å¡ç‰‡ç±»å‹ï¼ŒextraDataéœ€è¦å•ç‹¬å¤„ç†ï¼Œè¿™é‡Œçœç•¥
        messageMapper.insert(msg);

        // 2. å‡†å¤‡ä¸Šä¸‹æ–‡ä¿¡æ¯ (å¦‚æœå‰ç«¯å¸¦äº†productIdï¼Œå°±å»æŸ¥è¯¦æƒ…ç”¨äºæ›´æ–°ä¼šè¯å¿«ç…§)
        ProductSnapshot snapshot = null;
        if (currentContextProductId != null) {
            snapshot = productService.getSnapshot(currentContextProductId);
        }

        // 3. æ›´æ–°ã€å‘é€è€…ã€‘çš„ä¼šè¯åˆ—è¡¨
        ChatConversation selfConv = new ChatConversation();
        selfConv.setOwnerId(senderId);
        selfConv.setPeerId(receiverId);
        selfConv.setLastMsgContent(content);
        selfConv.setLastMsgTime(now);
        selfConv.setUnreadCount(0); // è‡ªå·±å‘çš„ï¼Œæœªè¯»æ•°å¢é‡ä¸º0
        selfConv.setRelatedProductId(currentContextProductId); // æ›´æ–°ä¸Šä¸‹æ–‡
        selfConv.setRelatedProductInfo(snapshot);
        conversationMapper.saveOrUpdateConversation(selfConv);

        // 4. æ›´æ–°ã€æ¥æ”¶è€…ã€‘çš„ä¼šè¯åˆ—è¡¨
        ChatConversation peerConv = new ChatConversation();
        peerConv.setOwnerId(receiverId);
        peerConv.setPeerId(senderId);
        peerConv.setLastMsgContent(content);
        peerConv.setLastMsgTime(now);
        peerConv.setUnreadCount(1); // å¯¹æ–¹æœªè¯» +1
        peerConv.setRelatedProductId(currentContextProductId); // å¯¹æ–¹åˆ—è¡¨ä¹ŸåŒæ­¥æ˜¾ç¤ºè¿™ä¸ªå•†å“
        peerConv.setRelatedProductInfo(snapshot);
        conversationMapper.saveOrUpdateConversation(peerConv);
        
        // 5. è°ƒç”¨ WebSocket æ¨é€ (çœç•¥)
    }
}
```

#### 4. Controller (æ¥å£å±‚)

Java

```
@RestController
@RequestMapping("/api/chat")
public class ChatController {
    @Autowired private ChatService chatService;

    // å‰ç«¯ç‚¹å‡»å‘é€æŒ‰é’®æ—¶è°ƒç”¨
    @PostMapping("/send")
    public Result sendMessage(@RequestBody SendMessageRequest req) {
        // req.getProductId() å°±æ˜¯å‰ç«¯æ‚¬æµ®æ¡å½“å‰çš„ ID
        chatService.sendMessage(
            UserContext.getUserId(), 
            req.getTargetId(), 
            req.getContent(), 
            req.getProductId() 
        );
        return Result.success();
    }
}
```

------

### ğŸ”µ ç¬¬äºŒéƒ¨åˆ†ï¼šå‰ç«¯å¼€å‘ (Vue 3 / WebApp)

æˆ‘ä»¬å°†æ‹†åˆ†ä¸º `ChatContextBar` ç»„ä»¶å’Œ `ChatPage` é¡µé¢ã€‚

#### 1. ç»„ä»¶ï¼šæ‚¬æµ®å•†å“æ¡ (components/ChatContextBar.vue)

è´Ÿè´£å±•ç¤ºï¼ŒåŒ…å«ä¸€ä¸ªå…³é—­æŒ‰é’®ã€‚

HTML

```
<template>
  <div v-if="product" class="product-float-bar">
    <img :src="product.imgUrl" class="thumb" />
    <div class="info">
      <div class="price">ï¿¥{{ product.price }}</div>
      <div class="title">å½“å‰æ²Ÿé€š: {{ product.title }}</div>
    </div>
    <button @click="$emit('send-link', product)">å‘é€é“¾æ¥</button>
    <button class="close-btn" @click="$emit('close')">Ã—</button>
  </div>
</template>

<script setup>
defineProps(['product']); // æ¥æ”¶çˆ¶ç»„ä»¶ä¼ æ¥çš„å•†å“å¯¹è±¡
defineEmits(['close', 'send-link']);
</script>

<style>
.product-float-bar {
  position: fixed; top: 44px; left: 0; right: 0;
  height: 60px; background: #fff; z-index: 99;
  display: flex; align-items: center; padding: 0 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
</style>
```

#### 2. é¡µé¢ï¼šèŠå¤©ä¸»é¡µ (views/ChatPage.vue)

æ ¸å¿ƒé€»è¾‘ï¼š`onMounted` æ—¶å†³å®šæ‚¬æµ®æ¡æ˜¾ç¤ºä»€ä¹ˆã€‚

HTML

```
<template>
  <div class="chat-page">
    <NavBar :title="targetUser.name" />

    <ChatContextBar 
      v-if="currentContextProduct" 
      :product="currentContextProduct" 
      @close="clearContext"
    />

    <div class="msg-list" :style="{ paddingTop: currentContextProduct ? '60px' : '0' }">
      <div v-for="msg in msgList" :key="msg.id">
        </div>
    </div>

    <div class="input-area">
      <input v-model="inputText" />
      <button @click="handleSend">å‘é€</button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';
import { useRoute } from 'vue-router';
import { getSessionHistory, getProductDetail, sendMsgApi } from '@/api/chat';

const route = useRoute();
const msgList = ref([]);
const currentContextProduct = ref(null); // æ ¸å¿ƒçŠ¶æ€ï¼šå½“å‰æ‚¬æµ®æ˜¾ç¤ºçš„å•†å“
const targetUserId = route.query.targetId;

// åˆå§‹åŒ–é€»è¾‘
onMounted(async () => {
  // A. è·å–å†å²èŠå¤©è®°å½• & ä¼šè¯å…ƒæ•°æ®
  const sessionData = await getSessionHistory(targetUserId);
  msgList.value = sessionData.messages;

  // B. [æ ¸å¿ƒåˆ¤æ–­é€»è¾‘] å†³å®šæ‚¬æµ®æ¡æ˜¾ç¤ºä»€ä¹ˆ
  const urlProductId = route.query.productId; // URLå‚æ•° (å¼ºæ„å›¾)
  const historyProduct = sessionData.conversation?.relatedProductInfo; // å†å²è®°å½• (å¼±æ„å›¾)

  if (urlProductId) {
    // åœºæ™¯1ï¼šä»å•†å“è¯¦æƒ…é¡µè·³è¿›æ¥çš„ -> ä¼˜å…ˆè¯·æ±‚æœ€æ–°å•†å“ä¿¡æ¯
    const productDetail = await getProductDetail(urlProductId);
    currentContextProduct.value = productDetail;
  } else if (historyProduct) {
    // åœºæ™¯2ï¼šä»åˆ—è¡¨è¿›æ¥çš„ï¼Œä½†æ•°æ®åº“é‡Œæœ‰è®°å½• -> æ¢å¤æ˜¾ç¤º
    currentContextProduct.value = historyProduct;
  }
  // åœºæ™¯3ï¼šéƒ½æ²¡æœ‰ -> currentContextProduct ä¸º nullï¼Œä¸æ¸²æŸ“
});

// æ¸…é™¤æ‚¬æµ®æ¡
const clearContext = () => {
  currentContextProduct.value = null;
};

// å‘é€æ¶ˆæ¯é€»è¾‘
const handleSend = async () => {
  if (!inputText.value) return;

  // æ„é€ å‘é€å‚æ•°
  const payload = {
    targetId: targetUserId,
    content: inputText.value,
    // [å…³é”®] å‘Šè¯‰åç«¯ï¼Œæˆ‘ç°åœ¨çœ‹ç€å“ªä¸ªå•†å“åœ¨èŠå¤©
    // å¦‚æœç”¨æˆ·å…³é—­äº†æ‚¬æµ®æ¡ï¼Œè¿™é‡Œå°±æ˜¯ nullï¼Œåç«¯ä¼šæ¸…ç©ºå…³è”
    productId: currentContextProduct.value ? currentContextProduct.value.id : null
  };

  await sendMsgApi(payload);
  
  // æœ¬åœ°è¿½åŠ æ¶ˆæ¯ä¸Šå±...
  inputText.value = '';
};
</script>
```

### æµç¨‹æ€»ç»“

1. **ç”¨æˆ·è¿›å…¥**ï¼šVue çš„ `onMounted` é’©å­æ ¹æ® `route.query.productId` ä¼˜å…ˆæ¸²æŸ“ `currentContextProduct`ã€‚
2. **ç”¨æˆ·æµè§ˆ**ï¼šæ­¤æ—¶åªæ˜¯å‰ç«¯ UI å±•ç¤ºï¼Œæ•°æ®åº“å°šæœªå˜æ›´ã€‚
3. **ç”¨æˆ·å‘é€**ï¼š
   - ç‚¹å‡»â€œå‘é€â€æŒ‰é’®ã€‚
   - Vue æå– `currentContextProduct.id` æ”¾å…¥ Payloadã€‚
   - è°ƒç”¨ API `/api/chat/send`ã€‚
4. **åç«¯å¤„ç†**ï¼š
   - `ChatController` æ¥æ”¶è¯·æ±‚ã€‚
   - `ChatService` è°ƒç”¨ `saveOrUpdateConversation`ã€‚
   - MyBatis æ‰§è¡Œ `ON DUPLICATE KEY UPDATE`ï¼Œå°† `related_product_id` å†™å…¥æ•°æ®åº“ã€‚
5. **ç»“æœ**ï¼šä¸‹æ¬¡ä»åˆ—è¡¨é¡µè¿›æ¥ï¼Œå› ä¸ºæ•°æ®åº“å·²æ›´æ–°ï¼Œå³ä½¿ç”¨æˆ·æ²¡å¸¦ URL å‚æ•°ï¼Œä¹Ÿä¼šè‡ªåŠ¨æ˜¾ç¤ºè¯¥å•†å“æ‚¬æµ®æ¡ã€‚
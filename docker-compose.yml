version: '3.8'

services:
  # --------------------------------------------------------
  # 1. MySQL 数据库服务
  # --------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: sht-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: zyc20050817       # 对应 application.properties 中的密码
      MYSQL_DATABASE: second_hand_trading    # 对应数据库名
      MYSQL_TCP_PORT: 3306
    ports:
      - "3306:3306"
    volumes:
      # 将宿主机的 mysql-data 目录挂载进去，保证删除容器后数据不丢失
      - ./mysql-data:/var/lib/mysql
      # 将项目根目录下的 SQL 脚本挂载到初始化目录，容器首次启动会自动执行建表
      - ./second_hand_trading.sql:/docker-entrypoint-initdb.d/init.sql
    command: 
      # 解决 MySQL 8.0 认证插件兼容性问题 & 设置时区
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci

  # --------------------------------------------------------
  # 2. Eureka 注册中心
  # --------------------------------------------------------
  eureka-server:
    build:
      context: .
      dockerfile: eureka-server/Dockerfile
    container_name: sht-eureka
    ports:
      - "8761:8761"
    environment:
      # 告诉 Eureka 容器它的主机名是 eureka-server，方便其他服务调用
      - EUREKA_INSTANCE_HOSTNAME=eureka-server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --------------------------------------------------------
  # 3. Server 核心业务服务
  # --------------------------------------------------------
  server:
    build:
      context: .
      dockerfile: Server/Dockerfile
    container_name: sht-server
    restart: on-failure
    ports:
      - "8080:8080"
    depends_on:
      - mysql
      - eureka-server
    environment:
      # 覆盖 application.properties 中的 localhost 配置
      # 格式: spring.datasource.url -> SPRING_DATASOURCE_URL
      # 注意：这里的 host 必须写 docker-compose 中的服务名 'mysql'
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/second_hand_trading?serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf-8
      SPRING_DATASOURCE_PASSWORD: zyc20050817
      # 修改 Eureka 地址指向容器名 'eureka-server'
      EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE: http://eureka-server:8761/eureka/

  # --------------------------------------------------------
  # 4. Gateway 网关服务
  # --------------------------------------------------------
  gateway:
    build:
      context: .
      dockerfile: gateway/Dockerfile
    container_name: sht-gateway
    restart: on-failure
    ports:
      - "8040:8040"
    depends_on:
      - server
      - eureka-server
    environment:
      # 修改 Eureka 地址
      EUREKA_CLIENT_SERVICE-URL_DEFAULTZONE: http://eureka-server:8761/eureka/

  # --------------------------------------------------------
  # 5. WebApp 前端 (Nginx)
  # --------------------------------------------------------
  webapp:
    build:
      context: ./WebApp   # 注意：前端的构建上下文是 WebApp 子目录
      dockerfile: Dockerfile
    container_name: sht-webapp
    ports:
      - "80:80"           # 宿主机 80 端口 -> 容器 80 端口
    depends_on:
      - gateway